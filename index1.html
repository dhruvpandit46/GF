<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Just talk... with Mitali üíï</title>
  <style>
  /* Reset & Global */
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  background: linear-gradient(135deg, #667eea, #764ba2);
  height: 100vh;
  width: 100vw;
  overflow: hidden;
}

/* Chat Container */
.chat-container {
  width: 100%;
  height: 100%;
  background: #fefefe;
  display: flex;
  flex-direction: column;
  border-radius: 15px;
  box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
  overflow: hidden;
  transition: transform 0.3s ease;
}

/* Header */
.header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 15px 25px;
  background: linear-gradient(135deg, #f093fb, #f5576c);
  box-shadow: 0 2px 15px rgba(0, 0, 0, 0.1);
  position: relative;
  z-index: 10;
}

.profile-pic {
  width: 55px;
  height: 55px;
  border-radius: 50%;
  border: 3px solid #fff;
  object-fit: cover;
  cursor: pointer;
  transition: transform 0.3s ease, box-shadow 0.3s ease;
  box-shadow: 0 6px 12px rgba(0,0,0,0.25);
}

.profile-pic:hover {
  transform: scale(1.1);
  box-shadow: 0 8px 20px rgba(0,0,0,0.3);
}

.header-info {
  flex: 1;
  color: #fff;
  margin-left: 15px;
}

.header-info h2 {
  font-size: 22px;
  font-weight: 600;
}

.header-info #status {
  font-size: 13px;
  opacity: 0.9;
  display: flex;
  align-items: center;
  gap: 6px;
  font-weight: 500;
}

.online-dot {
  width: 9px;
  height: 9px;
  border-radius: 50%;
  background: #00a884;
  animation: pulse 1.8s infinite;
}

.typing-indicator-dot {
  width: 4px;
  height: 4px;
  border-radius: 50%;
  background: #00a884;
  animation: typingDot 1.4s infinite;
  margin: 0 1px;
}

.typing-indicator-dot:nth-child(2) { animation-delay: 0.2s; }
.typing-indicator-dot:nth-child(3) { animation-delay: 0.4s; }

@keyframes pulse {
  0%,100% { opacity:1; }
  50% { opacity:0.4; }
}

@keyframes typingDot {
  0%,60%,100% { transform: translateY(0); }
  30% { transform: translateY(-4px); }
}

.header-actions {
  display: flex;
  gap: 15px;
}

.header-btn {
  width: 42px;
  height: 42px;
  border-radius: 50%;
  background: rgba(255,255,255,0.2);
  border: none;
  font-size: 18px;
  color: #fff;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.3s ease;
}

.header-btn:hover {
  background: rgba(255,255,255,0.35);
  transform: scale(1.1);
}

/* Time Context Bar */
.time-context-bar {
  background: linear-gradient(135deg, #4facfe, #00f2fe);
  color: white;
  padding: 8px 20px;
  font-size: 13px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
  border-bottom: 1px solid rgba(255,255,255,0.2);
}

.time-context-left, .time-context-right {
  display: flex;
  align-items: center;
  gap: 15px;
}

.time-context-item {
  display: flex;
  align-items: center;
  gap: 6px;
}

.time-context-icon {
  font-size: 14px;
}

/* Chat Window */
.chat-window {
  flex: 1;
  padding: 20px 25px;
  background: #e5ddd5;
  background-image: repeating-linear-gradient(
    45deg,
    transparent,
    transparent 12px,
    rgba(255,255,255,0.06) 12px,
    rgba(255,255,255,0.06) 24px
  );
  display: flex;
  flex-direction: column;
  gap: 12px;
  overflow-y: auto;
  scrollbar-width: thin;
  scrollbar-color: rgba(0,0,0,0.2) transparent;
  scroll-behavior: smooth;
}

.chat-window::-webkit-scrollbar {
  width: 7px;
}

.chat-window::-webkit-scrollbar-track {
  background: transparent;
}

.chat-window::-webkit-scrollbar-thumb {
  background: rgba(0,0,0,0.2);
  border-radius: 10px;
}

.date-divider {
  text-align: center;
  color: #666;
  font-size: 13px;
  margin: 15px 0;
}

.date-divider span {
  background: rgba(225,245,254,0.9);
  padding: 5px 14px;
  border-radius: 12px;
  font-weight: 500;
}

/* Messages */
.message {
  max-width: 75%;
  padding: 12px 18px;
  border-radius: 18px;
  line-height: 1.5;
  word-wrap: break-word;
  position: relative;
  box-shadow: 0 3px 10px rgba(0,0,0,0.1);
  font-size: 15px;
  animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
  from {opacity:0; transform: translateY(10px);}
  to {opacity:1; transform: translateY(0);}
}

.message.user {
  align-self: flex-end;
  background: linear-gradient(135deg, #dcf8c6, #c5e8a8);
  border-bottom-right-radius: 5px;
  color: #333;
}

.message.ai {
  align-self: flex-start;
  background: linear-gradient(135deg, #fff, #f8f9fa);
  border-bottom-left-radius: 5px;
  color: #333;
  border: 1px solid #e9ecef;
}

.message img {
  max-width: 100%;
  max-height: 320px;
  border-radius: 12px;
  margin-top: 8px;
  cursor: pointer;
  transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.message img:hover {
  transform: scale(1.03);
  box-shadow: 0 6px 16px rgba(0,0,0,0.2);
}

.message-time {
  font-size: 11px;
  color: rgba(0,0,0,0.45);
  margin-top: 6px;
  text-align: right;
}

/* Typing Indicator */
.typing-indicator {
  align-self: flex-start;
  background: #fff;
  padding: 12px 18px;
  border-radius: 18px;
  border-bottom-left-radius: 5px;
  display: flex;
  gap: 6px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.12);
  max-width: 80px;
  margin-bottom: 5px;
  border: 1px solid #e9ecef;
}

.typing-indicator span {
  width: 9px;
  height: 9px;
  background: #90949c;
  border-radius: 50%;
  animation: typing 1.4s infinite;
}

.typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
.typing-indicator-dot:nth-child(3) { animation-delay: 0.4s; }

@keyframes typing {
  0%,60%,100% { transform: translateY(0); }
  30% { transform: translateY(-8px); }
}

.hidden { display: none !important; }

/* Input Area */
.input-container {
  display: flex;
  align-items: center;
  padding: 15px 20px;
  gap: 10px;
  background: #f8f8f8;
  border-top: 1px solid #ddd;
  position: relative;
}

#userInput {
  flex: 1;
  padding: 14px 20px;
  font-size: 15px;
  border-radius: 25px;
  border: 1px solid #ddd;
  outline: none;
  background: #fff;
  transition: all 0.3s;
  font-family: inherit;
}

#userInput:focus {
  border-color: #667eea;
  box-shadow: 0 0 12px rgba(102,126,234,0.25);
}

.input-btn {
  width: 46px;
  height: 46px;
  border-radius: 50%;
  border: none;
  font-size: 20px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: all 0.2s ease;
  background: #fff;
  border: 1px solid #e0e0e0;
}

.input-btn:hover {
  background: #f5f5f5;
  transform: scale(1.05);
}

#sendBtn {
  background: linear-gradient(135deg, #00a884, #06cf9c);
  color: #fff;
  border: none;
}

#sendBtn:hover {
  background: linear-gradient(135deg, #06cf9c, #00a884);
  transform: scale(1.05);
}

#sendBtn:disabled {
  background: #ccc;
  cursor: not-allowed;
  transform: none;
}

/* Profile Modal */
.photo-modal {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.95);
  z-index: 1000;
  justify-content: center;
  align-items: center;
  animation: fadeInModal 0.3s ease;
}

.photo-modal.active { display: flex; }

.photo-modal-content {
  max-width: 90%;
  max-height: 90%;
  position: relative;
}

.photo-modal img {
  max-width: 100%;
  max-height: 90vh;
  border-radius: 12px;
  box-shadow: 0 10px 50px rgba(0,0,0,0.5);
}

.close-modal {
  position: absolute;
  top: 15px;
  right: 15px;
  width: 45px;
  height: 45px;
  border-radius: 50%;
  border: none;
  font-size: 24px;
  background: rgba(255,255,255,0.9);
  cursor: pointer;
  color: #333;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.3s ease;
}

.close-modal:hover {
  transform: rotate(90deg);
  background: #fff;
}

.photo-info {
  position: absolute;
  bottom: 20px;
  left: 50%;
  transform: translateX(-50%);
  background: rgba(0,0,0,0.75);
  color: #fff;
  padding: 8px 18px;
  border-radius: 20px;
  font-size: 14px;
}

/* Settings Modal */
.settings-modal {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.5);
  z-index: 999;
  justify-content: center;
  align-items: center;
  backdrop-filter: blur(3px);
}

.settings-modal.active { display: flex; }

.settings-content {
  background: #fff;
  padding: 30px 25px;
  border-radius: 20px;
  max-width: 500px;
  width: 90%;
  box-shadow: 0 10px 40px rgba(0,0,0,0.3);
  animation: slideUp 0.3s ease;
  max-height: 85vh;
  overflow-y: auto;
}

@keyframes slideUp {
  from { transform: translateY(20px); opacity: 0; }
  to { transform: translateY(0); opacity: 1; }
}

.settings-content h3 {
  margin-bottom: 20px;
  color: #333;
  font-weight: 600;
  text-align: center;
  font-size: 22px;
}

.setting-item {
  margin-bottom: 20px;
}

.setting-item label {
  display: block;
  font-size: 14px;
  color: #555;
  margin-bottom: 8px;
  font-weight: 500;
}

.setting-item input, .setting-item select {
  width: 100%;
  padding: 12px 15px;
  border-radius: 10px;
  border: 1.8px solid #e0e0e0;
  font-size: 14px;
  outline: none;
  transition: all 0.3s;
  background: #fff;
  font-family: inherit;
}

.setting-item input:focus, .setting-item select:focus {
  border-color: #667eea;
  box-shadow: 0 0 8px rgba(102,126,234,0.25);
}

.settings-actions {
  display: flex;
  gap: 12px;
  margin-top: 25px;
}

.settings-btn {
  flex: 1;
  padding: 13px;
  font-weight: 600;
  border-radius: 10px;
  border: none;
  font-size: 15px;
  cursor: pointer;
  transition: all 0.3s;
  font-family: inherit;
}

.settings-btn.save {
  background: linear-gradient(135deg, #00a884, #06cf9c);
  color: #fff;
}

.settings-btn.save:hover {
  background: linear-gradient(135deg, #06cf9c, #00a884);
  transform: translateY(-2px);
}

.settings-btn.cancel {
  background: #f0f0f0;
  color: #333;
}

.settings-btn.cancel:hover {
  background: #e0e0e0;
  transform: translateY(-2px);
}

/* Response Loader */
.response-loader {
  display: none;
  align-self: flex-start;
  background: #fff;
  padding: 10px 18px;
  border-radius: 18px;
  border-bottom-left-radius: 5px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.12);
  font-size: 13px;
  color: #00a884;
  border: 1px solid #e9ecef;
  font-weight: 500;
}

.response-loader.active {
  display: block;
}

/* Model Info Badge */
.model-badge {
  display: inline-block;
  padding: 3px 8px;
  border-radius: 10px;
  font-size: 11px;
  font-weight: 500;
  margin-left: 8px;
  background: #e3f2fd;
  color: #1976d2;
  border: 1px solid #bbdefb;
}

/* Typing Status */
.typing-status {
  color: #00a884;
  font-weight: 500;
  font-size: 13px;
  display: flex;
  align-items: center;
  gap: 5px;
  animation: fadeInOut 2s infinite;
}

@keyframes fadeInOut {
  0%, 100% { opacity: 0.7; }
  50% { opacity: 1; }
}

/* Call Interface */
.call-interface {
  display: none;
  position: fixed;
  inset: 0;
  background: linear-gradient(135deg, #1a1a2e, #16213e);
  z-index: 9999;
  flex-direction: column;
  align-items: center;
  justify-content: space-between;
  padding: 40px 20px;
  color: #fff;
}

.call-interface.active {
  display: flex;
}

.call-header {
  text-align: center;
  margin-top: 40px;
}

.call-profile {
  width: 180px;
  height: 180px;
  border-radius: 50%;
  border: 5px solid rgba(255, 255, 255, 0.3);
  object-fit: cover;
  margin-bottom: 20px;
  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
}

.call-name {
  font-size: 28px;
  font-weight: 600;
  margin-bottom: 10px;
}

.call-status {
  font-size: 16px;
  color: #aaa;
  margin-bottom: 40px;
}

.call-timer {
  font-size: 48px;
  font-weight: 300;
  margin-bottom: 60px;
  font-variant-numeric: tabular-nums;
}

.call-controls {
  display: flex;
  gap: 30px;
  margin-bottom: 60px;
}

.call-control-btn {
  width: 70px;
  height: 70px;
  border-radius: 50%;
  border: none;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 24px;
  cursor: pointer;
  transition: all 0.3s ease;
  background: rgba(255, 255, 255, 0.1);
  color: #fff;
  backdrop-filter: blur(10px);
}

.call-control-btn:hover {
  transform: scale(1.1);
}

#hangupBtn {
  background: linear-gradient(135deg, #ff416c, #ff4b2b);
}

#muteBtn {
  background: linear-gradient(135deg, #3498db, #2980b9);
}

#muteBtn.muted {
  background: linear-gradient(135deg, #e74c3c, #c0392b);
}

#speakerBtn {
  background: linear-gradient(135deg, #2ecc71, #27ae60);
}

#speakerBtn.speakerphone {
  background: linear-gradient(135deg, #f39c12, #e67e22);
}

.call-bottom-info {
  text-align: center;
  font-size: 14px;
  color: #aaa;
  margin-bottom: 20px;
}

/* Voice Activity Indicator */
.voice-activity {
  width: 100%;
  height: 80px;
  display: flex;
  justify-content: center;
  align-items: center;
  margin: 20px 0;
}

.voice-bar {
  width: 6px;
  height: 20px;
  background: #25d366;
  margin: 0 3px;
  border-radius: 3px;
  animation: voicePulse 1.5s infinite;
}

.voice-bar:nth-child(2) { animation-delay: 0.1s; }
.voice-bar:nth-child(3) { animation-delay: 0.2s; }
.voice-bar:nth-child(4) { animation-delay: 0.3s; }
.voice-bar:nth-child(5) { animation-delay: 0.4s; }
.voice-bar:nth-child(6) { animation-delay: 0.5s; }
.voice-bar:nth-child(7) { animation-delay: 0.6s; }

@keyframes voicePulse {
  0%, 100% { height: 20px; }
  50% { height: 60px; }
}

/* Ringing Animation */
.ringing-animation {
  position: relative;
}

.ringing-animation::before,
.ringing-animation::after {
  content: '';
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  width: 220px;
  height: 220px;
  border-radius: 50%;
  border: 2px solid rgba(255, 255, 255, 0.3);
  animation: ripple 2s infinite;
}

.ringing-animation::after {
  animation-delay: 1s;
}

@keyframes ripple {
  0% { width: 180px; height: 180px; opacity: 1; }
  100% { width: 300px; height: 300px; opacity: 0; }
}

/* Loading Spinner */
.tts-loading {
  display: none;
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  z-index: 10001;
  background: rgba(0, 0, 0, 0.8);
  padding: 20px;
  border-radius: 10px;
  color: white;
  text-align: center;
}

.tts-loading.active {
  display: block;
}

.spinner {
  width: 40px;
  height: 40px;
  border: 4px solid #f3f3f3;
  border-top: 4px solid #25d366;
  border-radius: 50%;
  animation: spin 1s linear infinite;
  margin: 0 auto 10px;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

/* Animations */
@keyframes fadeInModal {
  from { opacity: 0; }
  to { opacity: 1; }
}

/* Mobile Responsiveness */
@media (max-width: 768px) {
  .header { padding: 12px 18px; }
  .profile-pic { width: 45px; height: 45px; }
  .header-info h2 { font-size: 18px; }
  .message { max-width: 85%; font-size: 14px; padding: 10px 14px; }
  .chat-window { padding: 15px; }
  .input-container { padding: 12px 15px; }
  .input-btn { width: 42px; height: 42px; }
  #userInput { padding: 12px 16px; }
  .settings-content { padding: 25px 20px; }
  .model-badge { margin-left: 5px; padding: 2px 6px; font-size: 10px; }
  .call-profile { width: 140px; height: 140px; }
  .call-name { font-size: 24px; }
  .call-timer { font-size: 36px; }
  .call-controls { gap: 20px; }
  .call-control-btn { width: 60px; height: 60px; font-size: 20px; }
  .time-context-bar { font-size: 11px; padding: 6px 15px; }
  .time-context-left, .time-context-right { gap: 10px; }
}

@media (max-width: 480px) {
  .message { max-width: 90%; }
  .header-actions { gap: 10px; }
  .header-btn { width: 38px; height: 38px; }
  .call-profile { width: 120px; height: 120px; }
  .call-name { font-size: 20px; }
  .call-timer { font-size: 28px; }
  .call-controls { gap: 15px; }
  .call-control-btn { width: 50px; height: 50px; font-size: 18px; }
  .time-context-bar { flex-direction: column; gap: 5px; }
  .time-context-left, .time-context-right { width: 100%; justify-content: center; }
}

/* Additional Animations */
@keyframes slideIn {
  from { transform: translateX(100%); opacity: 0; }
  to { transform: translateX(0); opacity: 1; }
}

@keyframes slideOut {
  from { transform: translateX(0); opacity: 1; }
  to { transform: translateX(100%); opacity: 0; }
}

@keyframes shimmer {
  0% { background-position: -200% 0; }
  100% { background-position: 200% 0; }
}
  </style>
</head>
<body>
  <!-- TTS Loading Indicator -->
  <div class="tts-loading" id="ttsLoading">
    <div class="spinner"></div>
    <div>Generating Indian voice...</div>
  </div>

  <!-- Chat Interface -->
  <div class="chat-container" id="chatContainer">
    <!-- Header -->
    <div class="header">
      <img src="profile_pic.jpg" alt="Mitali" class="profile-pic" id="profilePic">
      <div class="header-info">
        <h2>Mitali üíï</h2>
        <span id="status"><span class="online-dot"></span> <span id="statusText">Online</span></span>
      </div>
      <div class="header-actions">
        <button class="header-btn" id="callHeaderBtn" title="Voice Call">üìû</button>
        <button class="header-btn" id="settingsBtn" title="Settings">‚öôÔ∏è</button>
        <button class="header-btn" id="clearBtn" title="Clear Chat">üóëÔ∏è</button>
      </div>
    </div>

    <!-- Time Context Bar -->
    <div class="time-context-bar" id="timeContextBar">
      <div class="time-context-left">
        <div class="time-context-item">
          <span class="time-context-icon">üìç</span>
          <span id="currentLocation">Ahmedabad, Gujarat</span>
        </div>
        <div class="time-context-item">
          <span class="time-context-icon">üïí</span>
          <span id="currentIndianTime">Loading...</span>
        </div>
      </div>
      <div class="time-context-right">
        <div class="time-context-item">
          <span class="time-context-icon">üìÖ</span>
          <span id="currentDate">Monday, February 3, 2025</span>
        </div>
        <div class="time-context-item">
          <span class="time-context-icon">üå§Ô∏è</span>
          <span id="currentSeason">Winter</span>
        </div>
      </div>
    </div>

    <!-- Chat Window -->
    <div class="chat-window" id="chatWindow">
      <div class="date-divider">
        <span id="todayDate">Today</span>
      </div>
      <!-- Initial AI Message -->
      <div class="message ai">
        <p>Namaste jaan! ü•∞ Aap kaise ho? I'm Mitali, your virtual wife. Aap mujhse kuch bhi share kar sakte ho - baatein, photos, ya bas time pass! üíï</p>
        <div class="message-time" id="initialTime">Just now</div>
      </div>
    </div>

    <!-- Typing Indicator -->
    <div class="typing-indicator hidden" id="typingIndicator">
      <span></span><span></span><span></span>
    </div>

    <!-- Response Loader -->
    <div class="response-loader hidden" id="responseLoader">Mitali is typing...</div>

    <!-- Input Container -->
    <div class="input-container">
      <label for="imageInput" class="input-btn" title="Send Image">üì∑</label>
      <input type="file" id="imageInput" accept="image/*" style="display: none;">
      <input type="text" id="userInput" placeholder="Type a message to Mitali..." autocomplete="off">
      <button class="input-btn" id="emojiBtn" title="Add Emoji">üòä</button>
      <button class="input-btn" id="sendBtn">‚û§</button>
    </div>
  </div>

  <!-- Call Interface -->
  <div class="call-interface" id="callInterface">
    <div class="call-header">
      <img src="profile_pic.jpg" alt="Mitali" class="call-profile ringing-animation" id="callProfile">
      <div class="call-name">Mitali üíï</div>
      <div class="call-status" id="callStatus">Calling...</div>
      <div class="call-timer" id="callTimer">00:00</div>
    </div>
    
    <div class="voice-activity" id="voiceActivity">
      <div class="voice-bar"></div>
      <div class="voice-bar"></div>
      <div class="voice-bar"></div>
      <div class="voice-bar"></div>
      <div class="voice-bar"></div>
      <div class="voice-bar"></div>
      <div class="voice-bar"></div>
    </div>
    
    <div class="call-controls">
      <button class="call-control-btn" id="muteBtn" title="Mute">üé§</button>
      <button class="call-control-btn" id="hangupBtn" title="Hang Up">üìû</button>
      <button class="call-control-btn" id="speakerBtn" title="Speaker">üîä</button>
    </div>
    
    <div class="call-bottom-info">
      <div id="callInfo">Voice call with your virtual wife</div>
      <div id="callQuality" style="margin-top: 5px; font-size: 12px;">Using Indian female voice</div>
    </div>
  </div>

  <!-- Profile Photo Modal -->
  <div class="photo-modal" id="photoModal">
    <button class="close-modal" id="closeModal">‚úï</button>
    <div class="photo-modal-content">
      <img src="profile_pic.jpg" alt="Profile Photo" id="modalImage">
      <div class="photo-info">Mitali Patel | Your Virtual Wife üíï</div>
    </div>
  </div>

  <!-- Settings Modal -->
  <div class="settings-modal" id="settingsModal">
    <div class="settings-content">
      <h3>‚öôÔ∏è AI & Voice Settings</h3>
      
      <!-- Time Awareness Section -->
      <div class="setting-item">
        <label>Time Awareness Level:</label>
        <select id="timeAwarenessSelect" style="width: 100%; padding: 12px 15px; border-radius: 10px; border: 1.8px solid #e0e0e0;">
          <option value="full" selected>üïí Full Time Awareness (Recommended)</option>
          <option value="basic">‚è∞ Basic Time Awareness</option>
          <option value="date">üìÖ Date Only</option>
          <option value="none">‚ùå No Time Awareness</option>
        </select>
      </div>
      
      <!-- Location Selection -->
      <div class="setting-item">
        <label>Location Selection:</label>
        <select id="locationSelect" style="width: 100%; padding: 12px 15px; border-radius: 10px; border: 1.8px solid #e0e0e0;">
          <option value="Ahmedabad" selected>üìç Ahmedabad, Gujarat</option>
          <option value="Delhi">üìç Delhi, NCR</option>
          <option value="Mumbai">üìç Mumbai, Maharashtra</option>
          <option value="Bangalore">üìç Bangalore, Karnataka</option>
          <option value="custom">üìç Custom Location</option>
        </select>
      </div>
      
      <div class="setting-item" id="customLocationContainer" style="display: none;">
        <label>Custom Location:</label>
        <input type="text" id="customLocationInput" placeholder="Enter any location in India">
      </div>
      
      <div class="setting-item">
        <label>AI API Key (Groq):</label>
        <input type="password" id="apiKeyInput" placeholder="Enter your Groq API key" value="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">
        <small style="color: #666; font-size: 12px; display: block; margin-top: 5px;">Get free API key from <a href="https://console.groq.com/keys" target="_blank" style="color: #667eea; text-decoration: none; font-weight: 500;">Groq Console</a></small>
      </div>
      
      <div class="setting-item">
        <label>TTS API Key (ElevenLabs):</label>
        <input type="password" id="ttsApiKeyInput" placeholder="Enter your ElevenLabs API key (optional)">
        <small style="color: #666; font-size: 12px; display: block; margin-top: 5px;">Get free API key from <a href="https://elevenlabs.io/app" target="_blank" style="color: #667eea; text-decoration: none; font-weight: 500;">ElevenLabs</a> for Indian voice</small>
      </div>
      
      <div class="setting-item">
        <label>AI Model (Text Chat):</label>
        <select id="textModelSelect" style="width: 100%; padding: 12px 15px; border-radius: 10px; border: 1.8px solid #e0e0e0;">
          <option value="groq/compound">üèÜ Groq Compound (Best Overall)</option>
          <option value="groq/compound-mini">‚ö° Groq Compound Mini (Fast & Efficient)</option>
          <option value="openai/gpt-oss-120b">üåü OpenAI GPT-OSS 120B (Most Powerful)</option>
          <option value="openai/gpt-oss-20b">‚ö° OpenAI GPT-OSS 20B (Fast & Smart)</option>
          <option value="llama-3.1-8b-instant">‚ö° Llama 3.1 8B Instant (Ultra Fast Response)</option>
          <option value="llama-3.2-1b-preview">‚ö°‚ö° Llama 3.2 1B (Lightning Fast)</option>
          <option value="llama-3.2-3b-preview">‚ö° Llama 3.2 3B (Fast & Light)</option>
          <option value="moonshotai/kimi-k2-instruct-0905" selected>üíã Kimi K2 Instruct (Romantic & Flirty)</option>
          <option value="moonshotai/kimi-k2-instruct">üíï Kimi K2 (Affectionate & Loving)</option>
          <option value="qwen/qwen3-32b">üèÜ Qwen 3 32B (Excellent for Conversations)</option>
          <option value="llama-3.3-70b-versatile">‚≠ê Llama 3.3 70B (Best Overall Quality)</option>
        </select>
      </div>
      
      <div class="setting-item">
        <label>Indian Voice Type:</label>
        <select id="voiceSelect" style="width: 100%; padding: 12px 15px; border-radius: 10px; border: 1.8px solid #e0e0e0;">
          <option value="indian-sweet" selected>üå∏ Sweet Indian Girl (Recommended)</option>
          <option value="indian-romantic">üíï Romantic Indian Voice</option>
          <option value="indian-soft">üå∫ Soft Indian Female</option>
          <option value="indian-cute">üêá Cute Indian Girl</option>
          <option value="browser-fallback">üó£Ô∏è Browser Voice (Fallback)</option>
        </select>
        <small style="color: #666; font-size: 12px; display: block; margin-top: 5px;">Sweet Indian Girl uses ElevenLabs for authentic Indian accent</small>
      </div>
      
      <div class="setting-item">
        <label>Response Length:</label>
        <select id="lengthSelect" style="width: 100%; padding: 12px 15px; border-radius: 10px; border: 1.8px solid #e0e0e0;">
          <option value="200">Short (Quick flirty replies)</option>
          <option value="400" selected>Medium (Sweet conversations)</option>
          <option value="600">Long (Detailed romantic talks)</option>
        </select>
      </div>
      
      <div class="setting-item">
        <label>Typing Speed:</label>
        <select id="typingSpeedSelect" style="width: 100%; padding: 12px 15px; border-radius: 10px; border: 1.8px solid #e0e0e0;">
          <option value="fast" selected>‚ö° Fast (Quick typist)</option>
          <option value="normal">üê¢ Normal (Average typing)</option>
          <option value="slow">‚å®Ô∏è Slow (Thoughtful typing)</option>
          <option value="auto">ü§ñ Auto (Smart calculation)</option>
        </select>
      </div>
      
      <div class="setting-item">
        <label>Romantic Intensity:</label>
        <select id="romanceSelect" style="width: 100%; padding: 12px 15px; border-radius: 10px; border: 1.8px solid #e0e0e0;">
          <option value="0.7">Mild (Cute & Sweet)</option>
          <option value="0.85" selected>Moderate (Romantic & Loving)</option>
          <option value="1.0">High (Passionate & Flirty)</option>
          <option value="1.2">Very High (Intensely Romantic)</option>
          <option value="1.5">Maximum (Extremely Affectionate)</option>
        </select>
      </div>
      
      <div class="setting-item">
        <label>Call Ring Count (1-5):</label>
        <input type="range" id="ringCountInput" min="1" max="5" value="3" step="1" style="width: 100%;">
        <div style="display: flex; justify-content: space-between; font-size: 12px; color: #666; margin-top: 5px;">
          <span>1 Ring</span>
          <span id="ringCountValue">3 Rings</span>
          <span>5 Rings</span>
        </div>
      </div>
      
      <div class="settings-actions">
        <button class="settings-btn cancel" id="cancelSettings">Cancel</button>
        <button class="settings-btn save" id="saveSettings">Save & Test</button>
      </div>
    </div>
  </div>

  <!-- Audio Elements (hidden) -->
  <audio id="ringSound" preload="auto">
    <source src="ring.mp3" type="audio/mpeg">
  </audio>
  <audio id="greetingSound" preload="auto">
    <source src="greeting.mp3" type="audio/mpeg">
  </audio>

  <!-- Hidden audio element for TTS playback -->
  <audio id="ttsAudio" style="display: none;"></audio>

  <script>
    // DOM Elements
    const chatContainer = document.getElementById("chatContainer");
    const chatWindow = document.getElementById("chatWindow");
    const userInput = document.getElementById("userInput");
    const sendBtn = document.getElementById("sendBtn");
    const callHeaderBtn = document.getElementById("callHeaderBtn");
    const imageInput = document.getElementById("imageInput");
    const typingIndicator = document.getElementById("typingIndicator");
    const responseLoader = document.getElementById("responseLoader");
    const profilePic = document.getElementById("profilePic");
    const photoModal = document.getElementById("photoModal");
    const modalImage = document.getElementById("modalImage");
    const closeModal = document.getElementById("closeModal");
    const settingsBtn = document.getElementById("settingsBtn");
    const settingsModal = document.getElementById("settingsModal");
    const clearBtn = document.getElementById("clearBtn");
    const emojiBtn = document.getElementById("emojiBtn");
    const statusText = document.getElementById("statusText");
    const ttsLoading = document.getElementById("ttsLoading");
    const ttsAudio = document.getElementById("ttsAudio");
    const timeContextBar = document.getElementById("timeContextBar");
    const currentLocation = document.getElementById("currentLocation");
    const currentIndianTime = document.getElementById("currentIndianTime");
    const currentDate = document.getElementById("currentDate");
    const currentSeason = document.getElementById("currentSeason");
    
    // Call Interface Elements
    const callInterface = document.getElementById("callInterface");
    const callProfile = document.getElementById("callProfile");
    const callStatus = document.getElementById("callStatus");
    const callTimer = document.getElementById("callTimer");
    const hangupBtn = document.getElementById("hangupBtn");
    const muteBtn = document.getElementById("muteBtn");
    const speakerBtn = document.getElementById("speakerBtn");
    const voiceActivity = document.getElementById("voiceActivity");
    const ringSound = document.getElementById("ringSound");
    const greetingSound = document.getElementById("greetingSound");
    const ringCountInput = document.getElementById("ringCountInput");
    const ringCountValue = document.getElementById("ringCountValue");

    // State
    let chatHistory = [
      { 
        sender: "AI", 
        text: "Namaste jaan! ü•∞ Aap kaise ho? I'm Mitali, your virtual wife. Aap mujhse kuch bhi share kar sakte ho - baatein, photos, ya bas time pass! üíï",
        timestamp: new Date().toISOString()
      }
    ];
    let uploadedImage = null;
    let apiKey = localStorage.getItem("vgf_apiKey") || "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";
    let ttsApiKey = localStorage.getItem("vgf_ttsApiKey") || "";
    let textModel = localStorage.getItem("vgf_textModel") || "moonshotai/kimi-k2-instruct-0905";
    let maxTokens = parseInt(localStorage.getItem("vgf_maxTokens")) || 400;
    let romanceLevel = parseFloat(localStorage.getItem("vgf_romanceLevel")) || 0.85;
    let typingSpeed = localStorage.getItem("vgf_typingSpeed") || "fast";
    let voiceType = localStorage.getItem("vgf_voiceType") || "indian-sweet";
    let ringCount = parseInt(localStorage.getItem("vgf_ringCount")) || 3;
    let timeAwareness = localStorage.getItem("vgf_timeAwareness") || "full";
    let userLocation = localStorage.getItem("vgf_userLocation") || "Ahmedabad"; // Changed from 'location' to 'userLocation'
    let customLocation = localStorage.getItem("vgf_customLocation") || "";
    
    // Call State
    let isGenerating = false;
    let isCallActive = false;
    let isListening = false;
    let callStartTime = null;
    let callTimerInterval = null;
    let isMuted = false;
    let isSpeakerphone = false;
    let recognition = null;
    let synth = window.speechSynthesis;
    let ringTimeout = null;
    let greetingTimeout = null;
    let lastRecognitionTime = 0;
    let isAISpeaking = false;
    let currentAudio = null;

    // Time Management
    let timeUpdateInterval = null;
    
    // Typing speed configurations
    const TYPING_SPEEDS = {
      fast: 80,
      normal: 60,
      slow: 40,
      auto: null
    };

    // ElevenLabs Voice IDs for Indian voices
    const ELEVENLABS_VOICES = {
      'indian-sweet': 'MF3mGyEYCl7XYWbV9V6O',
      'indian-romantic': 'JBFqnCBsd6RMkjVDRZzb',
      'indian-soft': 'XB0fDUnXU5powFXDhCwa',
      'indian-cute': 'EXAVITQu4vr4xnSDxMaL'
    };

    // Indian Seasons (based on months)
    const INDIAN_SEASONS = {
      0: 'Winter',    // Jan
      1: 'Winter',    // Feb
      2: 'Summer',    // Mar
      3: 'Summer',    // Apr
      4: 'Summer',    // May
      5: 'Monsoon',   // Jun
      6: 'Monsoon',   // Jul
      7: 'Monsoon',   // Aug
      8: 'Autumn',    // Sep
      9: 'Autumn',    // Oct
      10: 'Winter',   // Nov
      11: 'Winter'    // Dec
    };

    // Location Data
    const LOCATION_DATA = {
      'Ahmedabad': {
        name: 'Ahmedabad, Gujarat',
        culturalContext: 'Gujarati culture, vegetarian food, business hub'
      },
      'Delhi': {
        name: 'Delhi, NCR',
        culturalContext: 'North Indian culture, street food, historical sites'
      },
      'Mumbai': {
        name: 'Mumbai, Maharashtra',
        culturalContext: 'Fast-paced life, Bollywood, street food'
      },
      'Bangalore': {
        name: 'Bangalore, Karnataka',
        culturalContext: 'Tech hub, pleasant weather, South Indian food'
      },
      'custom': {
        name: customLocation || 'Custom Location',
        culturalContext: 'Indian culture and traditions'
      }
    };

    // Initialize
    setTodayDate();
    loadSettings();
    updateInitialTime();
    updateIndianTime();
    ringCountInput.value = ringCount;
    ringCountValue.textContent = `${ringCount} Rings`;
    updateLocationDisplay();
    startTimeUpdates();

    // Event Listeners
    profilePic.addEventListener("click", () => {
      photoModal.classList.add("active");
    });

    closeModal.addEventListener("click", () => {
      photoModal.classList.remove("active");
    });

    photoModal.addEventListener("click", (e) => {
      if (e.target === photoModal) {
        photoModal.classList.remove("active");
      }
    });

    settingsBtn.addEventListener("click", () => {
      settingsModal.classList.add("active");
      document.getElementById("apiKeyInput").value = apiKey;
      document.getElementById("ttsApiKeyInput").value = ttsApiKey;
      document.getElementById("textModelSelect").value = textModel;
      document.getElementById("voiceSelect").value = voiceType;
      document.getElementById("lengthSelect").value = maxTokens;
      document.getElementById("romanceSelect").value = romanceLevel;
      document.getElementById("typingSpeedSelect").value = typingSpeed;
      document.getElementById("ringCountInput").value = ringCount;
      document.getElementById("timeAwarenessSelect").value = timeAwareness;
      document.getElementById("locationSelect").value = userLocation;
      document.getElementById("customLocationInput").value = customLocation;
      
      // Show/hide custom location input
      const customContainer = document.getElementById("customLocationContainer");
      if (userLocation === 'custom') {
        customContainer.style.display = 'block';
      } else {
        customContainer.style.display = 'none';
      }
      
      ringCountValue.textContent = `${ringCount} Rings`;
    });

    // Location selection change
    document.getElementById("locationSelect").addEventListener("change", (e) => {
      const customContainer = document.getElementById("customLocationContainer");
      if (e.target.value === 'custom') {
        customContainer.style.display = 'block';
      } else {
        customContainer.style.display = 'none';
      }
    });

    ringCountInput.addEventListener("input", (e) => {
      ringCountValue.textContent = `${e.target.value} Rings`;
    });

    document.getElementById("cancelSettings").addEventListener("click", () => {
      settingsModal.classList.remove("active");
    });

    document.getElementById("saveSettings").addEventListener("click", () => {
      apiKey = document.getElementById("apiKeyInput").value.trim();
      ttsApiKey = document.getElementById("ttsApiKeyInput").value.trim();
      textModel = document.getElementById("textModelSelect").value;
      voiceType = document.getElementById("voiceSelect").value;
      maxTokens = parseInt(document.getElementById("lengthSelect").value);
      romanceLevel = parseFloat(document.getElementById("romanceSelect").value);
      typingSpeed = document.getElementById("typingSpeedSelect").value;
      ringCount = parseInt(document.getElementById("ringCountInput").value);
      timeAwareness = document.getElementById("timeAwarenessSelect").value;
      userLocation = document.getElementById("locationSelect").value;
      customLocation = document.getElementById("customLocationInput").value.trim();
      
      if (!apiKey) {
        showToast("‚ö†Ô∏è Please enter your Groq API key!", "warning");
        return;
      }
      
      if (userLocation === 'custom' && !customLocation) {
        showToast("‚ö†Ô∏è Please enter a custom location!", "warning");
        return;
      }
      
      saveSettings();
      settingsModal.classList.remove("active");
      updateLocationDisplay();
      showToast("‚úÖ Settings saved!", "success");
    });

    clearBtn.addEventListener("click", () => {
      if (confirm("Clear all chat history? This cannot be undone.")) {
        chatHistory = [
          { 
            sender: "AI", 
            text: "Namaste jaan! ü•∞ Chat cleared! Main abhi fresh start kar rahi hoon. Aap kaise ho?",
            timestamp: new Date().toISOString()
          }
        ];
        chatWindow.innerHTML = `
          <div class="date-divider">
            <span id="todayDate">Today</span>
          </div>
          <div class="message ai">
            <p>Namaste jaan! ü•∞ Chat cleared! Main abhi fresh start kar rahi hoon. Aap kaise ho?</p>
            <div class="message-time">${new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' })}</div>
          </div>
        `;
        setTodayDate();
        showToast("Chat cleared successfully!", "success");
      }
    });

    emojiBtn.addEventListener("click", () => {
      const emojis = ["‚ù§Ô∏è", "üòò", "ü•∞", "üòä", "üòç", "üíï", "üåπ", "‚ú®", "üíñ", "üòö", "üíã", "üå∏", "üí´", "ü´∂", "ü§ó", "üòª", "üíû", "üå∫", "‚≠ê", "üî•", "üíù", "üòö", "ü•∫", "ü§≠", "üòâ", "üòè", "ü•µ", "üíò", "üíì", "üíó"];
      userInput.value += emojis[Math.floor(Math.random() * emojis.length)];
      userInput.focus();
    });

    imageInput.addEventListener("change", (e) => {
      const file = e.target.files[0];
      if (file) {
        if (file.size > 5 * 1024 * 1024) {
          showToast("‚ö†Ô∏è Image too large! Max 5MB.", "warning");
          return;
        }
        const reader = new FileReader();
        reader.onload = (event) => {
          uploadedImage = event.target.result;
          handleUserMessage(true);
        };
        reader.readAsDataURL(file);
      }
    });

    sendBtn.addEventListener("click", () => handleUserMessage(false));
    
    userInput.addEventListener("keypress", (e) => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        handleUserMessage(false);
      }
    });

    userInput.addEventListener("input", () => {
      sendBtn.disabled = !userInput.value.trim() || isGenerating;
    });

    // Call Event Listeners
    callHeaderBtn.addEventListener("click", startCall);
    hangupBtn.addEventListener("click", endCall);
    muteBtn.addEventListener("click", toggleMute);
    speakerBtn.addEventListener("click", toggleSpeaker);

    // Functions
    function setTodayDate() {
      const today = new Date().toLocaleDateString('en-US', { 
        weekday: 'long',
        month: 'short', 
        day: 'numeric', 
        year: 'numeric' 
      });
      const dateEl = document.getElementById("todayDate");
      if (dateEl) dateEl.textContent = today;
    }

    function updateInitialTime() {
      const initialTime = document.getElementById("initialTime");
      if (initialTime) {
        initialTime.textContent = getIndianTimeString();
      }
    }

    function updateIndianTime() {
      const now = new Date();
      const indianTime = new Date(now.getTime() + (5.5 * 60 * 60 * 1000));
      
      const timeString = indianTime.toLocaleTimeString('en-US', {
        hour: '2-digit',
        minute: '2-digit',
        hour12: true
      });
      
      // Determine time of day
      const hour = indianTime.getHours();
      let timeOfDay = '';
      if (hour >= 5 && hour < 12) timeOfDay = 'morning';
      else if (hour >= 12 && hour < 17) timeOfDay = 'afternoon';
      else if (hour >= 17 && hour < 21) timeOfDay = 'evening';
      else timeOfDay = 'night';
      
      // Update display
      currentIndianTime.textContent = `${timeString} (${timeOfDay})`;
      
      // Update date
      const dateString = indianTime.toLocaleDateString('en-US', {
        weekday: 'long',
        year: 'numeric',
        month: 'long',
        day: 'numeric'
      });
      currentDate.textContent = dateString;
      
      // Update season
      const month = indianTime.getMonth();
      currentSeason.textContent = INDIAN_SEASONS[month];
    }

    function startTimeUpdates() {
      updateIndianTime();
      timeUpdateInterval = setInterval(updateIndianTime, 60000);
    }

    function stopTimeUpdates() {
      if (timeUpdateInterval) {
        clearInterval(timeUpdateInterval);
        timeUpdateInterval = null;
      }
    }

    function getIndianTimeString() {
      const now = new Date();
      const indianTime = new Date(now.getTime() + (5.5 * 60 * 60 * 1000));
      return indianTime.toLocaleTimeString('en-US', { 
        hour: '2-digit', 
        minute: '2-digit' 
      });
    }

    function updateLocationDisplay() {
      const locationData = LOCATION_DATA[userLocation] || LOCATION_DATA['Ahmedabad'];
      currentLocation.textContent = userLocation === 'custom' ? customLocation : locationData.name;
    }

    function loadSettings() {
      const saved = localStorage.getItem("vgf_settings");
      if (saved) {
        try {
          const settings = JSON.parse(saved);
          apiKey = settings.apiKey || apiKey;
          ttsApiKey = settings.ttsApiKey || ttsApiKey;
          textModel = settings.textModel || textModel;
          maxTokens = settings.maxTokens || maxTokens;
          romanceLevel = settings.romanceLevel || romanceLevel;
          typingSpeed = settings.typingSpeed || typingSpeed;
          voiceType = settings.voiceType || voiceType;
          ringCount = settings.ringCount || ringCount;
          timeAwareness = settings.timeAwareness || timeAwareness;
          userLocation = settings.userLocation || userLocation;
          customLocation = settings.customLocation || customLocation;
        } catch (e) {
          console.error("Error loading settings:", e);
        }
      }
    }

    function saveSettings() {
      const settings = {
        apiKey,
        ttsApiKey,
        textModel,
        maxTokens,
        romanceLevel,
        typingSpeed,
        voiceType,
        ringCount,
        timeAwareness,
        userLocation, // Changed from location
        customLocation
      };
      localStorage.setItem("vgf_settings", JSON.stringify(settings));
      localStorage.setItem("vgf_apiKey", apiKey);
      localStorage.setItem("vgf_ttsApiKey", ttsApiKey);
      localStorage.setItem("vgf_textModel", textModel);
      localStorage.setItem("vgf_maxTokens", maxTokens);
      localStorage.setItem("vgf_romanceLevel", romanceLevel);
      localStorage.setItem("vgf_typingSpeed", typingSpeed);
      localStorage.setItem("vgf_voiceType", voiceType);
      localStorage.setItem("vgf_ringCount", ringCount);
      localStorage.setItem("vgf_timeAwareness", timeAwareness);
      localStorage.setItem("vgf_userLocation", userLocation); // Changed from location
      localStorage.setItem("vgf_customLocation", customLocation);
    }

    function showToast(message, type = "info") {
      const colors = {
        success: "#00a884",
        warning: "#ff9800",
        error: "#f44336",
        info: "#2196f3",
        romantic: "#e91e63"
      };
      
      const toast = document.createElement("div");
      toast.textContent = message;
      toast.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: ${colors[type] || colors.info};
        color: white;
        padding: 14px 22px;
        border-radius: 12px;
        z-index: 10000;
        animation: slideIn 0.3s ease;
        box-shadow: 0 6px 20px rgba(0,0,0,0.2);
        font-weight: 500;
        max-width: 300px;
        word-wrap: break-word;
      `;
      document.body.appendChild(toast);
      setTimeout(() => {
        toast.style.animation = "slideOut 0.3s ease";
        setTimeout(() => document.body.removeChild(toast), 300);
      }, 3000);
    }

    // Call Functions
    async function startCall() {
      if (isCallActive) return;
      
      isCallActive = true;
      chatContainer.style.transform = "translateX(-100%)";
      callInterface.classList.add("active");
      statusText.textContent = "On a call";
      
      // Show ringing animation
      callStatus.textContent = "Calling...";
      callProfile.classList.add("ringing-animation");
      voiceActivity.style.display = "none";
      
      // Play ring sound 1-5 times
      let ringsPlayed = 0;
      const maxRings = ringCount;
      
      function playRing() {
        if (ringsPlayed < maxRings && isCallActive) {
          ringSound.currentTime = 0;
          ringSound.play();
          ringsPlayed++;
          
          ringTimeout = setTimeout(playRing, 3000);
        } else if (isCallActive && ringsPlayed >= maxRings) {
          answerCall();
        }
      }
      
      playRing();
      
      // Initialize Web Speech API for STT
      initializeSpeechRecognition();
    }

    function answerCall() {
      clearTimeout(ringTimeout);
      callProfile.classList.remove("ringing-animation");
      callStatus.textContent = "Connected";
      voiceActivity.style.display = "flex";
      
      // Start call timer
      callStartTime = Date.now();
      updateCallTimer();
      callTimerInterval = setInterval(updateCallTimer, 1000);
      
      // Play greeting sound
      greetingSound.currentTime = 0;
      greetingSound.play();
      
      // Start listening AFTER the greeting finishes
      greetingTimeout = setTimeout(() => {
        startListening();
      }, 2000);
    }

    function endCall() {
      if (!isCallActive) return;
      
      isCallActive = false;
      isListening = false;
      isAISpeaking = false;
      
      // Clear all timeouts and intervals
      clearTimeout(ringTimeout);
      clearTimeout(greetingTimeout);
      clearInterval(callTimerInterval);
      
      // Stop speech recognition
      if (recognition) {
        try {
          recognition.stop();
        } catch (e) {
          // Ignore errors when stopping
        }
        recognition = null;
      }
      
      // Stop speech synthesis
      if (synth) {
        synth.cancel();
      }
      
      // Stop audio playback
      ringSound.pause();
      greetingSound.pause();
      ttsAudio.pause();
      ringSound.currentTime = 0;
      greetingSound.currentTime = 0;
      ttsAudio.currentTime = 0;
      
      // Clean up current audio
      if (currentAudio) {
        currentAudio.pause();
        currentAudio = null;
      }
      
      // Reset UI
      callInterface.classList.remove("active");
      chatContainer.style.transform = "translateX(0)";
      statusText.textContent = "Online";
      callStatus.textContent = "Call ended";
      callTimer.textContent = "00:00";
      voiceActivity.style.display = "none";
      
      // Reset mute/speaker
      isMuted = false;
      isSpeakerphone = false;
      muteBtn.classList.remove("muted");
      speakerBtn.classList.remove("speakerphone");
      
      // Hide TTS loading
      ttsLoading.classList.remove("active");
      
      showToast("üìû Call ended", "info");
    }

    function toggleMute() {
      isMuted = !isMuted;
      muteBtn.classList.toggle("muted", isMuted);
      
      if (isMuted) {
        muteBtn.title = "Unmute";
        if (recognition && isListening) {
          recognition.stop();
          isListening = false;
        }
      } else {
        muteBtn.title = "Mute";
        if (isCallActive && !isAISpeaking) {
          startListening();
        }
      }
      
      showToast(isMuted ? "üé§ Microphone muted" : "üé§ Microphone unmuted", "info");
    }

    function toggleSpeaker() {
      isSpeakerphone = !isSpeakerphone;
      speakerBtn.classList.toggle("speakerphone", isSpeakerphone);
      
      showToast(isSpeakerphone ? "üîä Speakerphone on" : "üîà Earpiece on", "info");
    }

    function updateCallTimer() {
      if (!callStartTime) return;
      
      const elapsed = Date.now() - callStartTime;
      const minutes = Math.floor(elapsed / 60000);
      const seconds = Math.floor((elapsed % 60000) / 1000);
      
      callTimer.textContent = 
        `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    }

    function initializeSpeechRecognition() {
      if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
        showToast("‚ö†Ô∏è Your browser doesn't support speech recognition.", "warning");
        return;
      }
      
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      recognition = new SpeechRecognition();
      
      recognition.continuous = false;
      recognition.interimResults = false;
      recognition.lang = 'en-IN';
      recognition.maxAlternatives = 1;
      
      recognition.onresult = async (event) => {
        if (isAISpeaking || !isCallActive) return;
        
        const transcript = event.results[0][0].transcript.trim();
        
        if (transcript && Date.now() - lastRecognitionTime > 2000) {
          lastRecognitionTime = Date.now();
          
          callStatus.textContent = "Processing...";
          await processSpeech(transcript);
        }
      };
      
      recognition.onerror = (event) => {
        if (event.error === 'aborted' || event.error === 'no-speech') {
          if (isCallActive && !isMuted && !isAISpeaking) {
            setTimeout(() => {
              if (recognition && isCallActive) {
                try {
                  recognition.start();
                  isListening = true;
                } catch (error) {
                  console.error("Error restarting recognition:", error);
                }
              }
            }, 500);
          }
        } else {
          console.error("Speech recognition error:", event.error);
        }
      };
      
      recognition.onend = () => {
        isListening = false;
        if (isCallActive && !isMuted && !isAISpeaking) {
          setTimeout(() => {
            if (recognition && isCallActive) {
              try {
                recognition.start();
                isListening = true;
                callStatus.textContent = "Ready to talk...";
              } catch (error) {
                console.error("Error restarting recognition:", error);
              }
            }
          }, 500);
        }
      };
    }

    async function processSpeech(text) {
      if (!isCallActive || isAISpeaking) return;
      
      callStatus.textContent = "Thinking...";
      
      try {
        const aiResponse = await getAIResponse(text, null, true);
        await speakWithIndianVoice(aiResponse);
      } catch (error) {
        console.error("Error processing speech:", error);
        const fallbackText = "Sorry jaan, I didn't understand that. Could you please say it again?";
        speakWithBrowserTTS(fallbackText);
      }
    }

    async function speakWithIndianVoice(text) {
      if (!isCallActive) return;
      
      isAISpeaking = true;
      callStatus.textContent = "Speaking...";
      
      if (ttsApiKey && voiceType !== 'browser-fallback') {
        ttsLoading.classList.add("active");
      }
      
      try {
        if (ttsApiKey && voiceType !== 'browser-fallback' && ELEVENLABS_VOICES[voiceType]) {
          await speakWithElevenLabs(text);
        } else {
          speakWithBrowserTTS(text);
        }
      } catch (error) {
        console.error("Error with ElevenLabs TTS:", error);
        speakWithBrowserTTS(text);
      } finally {
        ttsLoading.classList.remove("active");
      }
    }

    async function speakWithElevenLabs(text) {
      if (!ttsApiKey || !ELEVENLABS_VOICES[voiceType]) {
        throw new Error("No TTS API key or voice selected");
      }
      
      const voiceId = ELEVENLABS_VOICES[voiceType];
      const processedText = convertToSpeechText(text);
      
      const response = await fetch(`https://api.elevenlabs.io/v1/text-to-speech/${voiceId}`, {
        method: 'POST',
        headers: {
          'Accept': 'audio/mpeg',
          'Content-Type': 'application/json',
          'xi-api-key': ttsApiKey
        },
        body: JSON.stringify({
          text: processedText,
          model_id: 'eleven_multilingual_v2',
          voice_settings: {
            stability: 0.5,
            similarity_boost: 0.8,
            style: 0.3,
            use_speaker_boost: true
          }
        })
      });
      
      if (!response.ok) {
        throw new Error(`ElevenLabs API error: ${response.status}`);
      }
      
      const audioBlob = await response.blob();
      const audioUrl = URL.createObjectURL(audioBlob);
      
      // Create and play audio
      currentAudio = new Audio(audioUrl);
      currentAudio.onended = () => {
        isAISpeaking = false;
        callStatus.textContent = "Ready to talk...";
        URL.revokeObjectURL(audioUrl);
        currentAudio = null;
        
        if (!isMuted) {
          startListening();
        }
      };
      
      currentAudio.onerror = (error) => {
        console.error("Audio playback error:", error);
        isAISpeaking = false;
        callStatus.textContent = "Ready to talk...";
        URL.revokeObjectURL(audioUrl);
        currentAudio = null;
      };
      
      currentAudio.play();
    }

    function speakWithBrowserTTS(text) {
      if (!synth || !isCallActive) return;
      
      synth.cancel();
      
      const processedText = convertToSpeechText(text);
      const utterance = new SpeechSynthesisUtterance(processedText);
      
      const voices = synth.getVoices();
      const indianVoices = voices.filter(voice => 
        voice.lang.includes('IN') || 
        voice.name.toLowerCase().includes('india') ||
        voice.name.toLowerCase().includes('hindi')
      );
      
      if (indianVoices.length > 0) {
        utterance.voice = indianVoices[0];
        utterance.lang = 'en-IN';
      } else {
        utterance.lang = 'en-US';
      }
      
      utterance.rate = 0.9;
      utterance.pitch = 1.1;
      utterance.volume = 1;
      
      utterance.onstart = () => {
        isAISpeaking = true;
        callStatus.textContent = "Speaking...";
      };
      
      utterance.onend = () => {
        isAISpeaking = false;
        callStatus.textContent = "Ready to talk...";
        if (!isMuted) {
          startListening();
        }
      };
      
      utterance.onerror = () => {
        isAISpeaking = false;
        callStatus.textContent = "Ready to talk...";
      };
      
      synth.speak(utterance);
    }

    function convertToSpeechText(text) {
      return text
        .replace(/[^\w\s.,!?;:'"()\-]/g, ' ')
        .replace(/\s+/g, ' ')
        .trim();
    }

    function startListening() {
      if (recognition && isCallActive && !isMuted && !isAISpeaking && !isListening) {
        try {
          recognition.start();
          isListening = true;
          callStatus.textContent = "Ready to talk...";
        } catch (error) {
          console.error("Error starting speech recognition:", error);
          isListening = false;
          setTimeout(() => {
            if (isCallActive && !isMuted && !isAISpeaking) {
              startListening();
            }
          }, 1000);
        }
      }
    }

    // Chat Functions
    function renderMessage(sender, text, imageData = null) {
      if (isCallActive) return null;
      
      const msgDiv = document.createElement("div");
      msgDiv.classList.add("message", sender === "AI" ? "ai" : "user");
      
      if (imageData) {
        const img = document.createElement("img");
        img.src = imageData;
        img.alt = "Shared image";
        img.addEventListener("click", () => {
          modalImage.src = imageData;
          photoModal.classList.add("active");
        });
        msgDiv.appendChild(img);
      }

      if (text) {
        const textP = document.createElement("p");
        textP.textContent = text;
        textP.style.marginBottom = "4px";
        msgDiv.appendChild(textP);
      }

      const time = document.createElement("div");
      time.className = "message-time";
      time.textContent = getIndianTimeString();
      msgDiv.appendChild(time);

      chatWindow.appendChild(msgDiv);
      chatWindow.scrollTop = chatWindow.scrollHeight;
      return msgDiv;
    }

    function showTyping() {
      if (isCallActive) return;
      
      typingIndicator.classList.remove("hidden");
      responseLoader.classList.remove("hidden");
      
      statusText.innerHTML = `
        <span class="typing-status">
          <span class="typing-indicator-dot"></span>
          <span class="typing-indicator-dot"></span>
          <span class="typing-indicator-dot"></span>
          Typing...
        </span>
      `;
      
      chatWindow.scrollTop = chatWindow.scrollHeight;
    }

    function hideTyping() {
      if (isCallActive) return;
      
      typingIndicator.classList.add("hidden");
      responseLoader.classList.add("hidden");
      statusText.innerHTML = "Online";
    }

    function calculateTypingDelay(text) {
      if (!text) return 1000;
      
      const charCount = text.length;
      const wordCount = text.split(/\s+/).length;
      const emojiCount = (text.match(/[\u{1F600}-\u{1F64F}\u{1F300}-\u{1F5FF}\u{1F680}-\u{1F6FF}\u{1F1E0}-\u{1F1FF}\u{2600}-\u{26FF}\u{2700}-\u{27BF}]/gu) || []).length;
      const punctuationCount = (text.match(/[.,!?;:]/g) || []).length;
      
      let baseDelay;
      
      if (typingSpeed === "auto") {
        const thinkingTime = 800 + (wordCount * 10);
        const typingTime = (charCount / 200) * 60000;
        const complexityMultiplier = 1 + (emojiCount * 0.1) + (punctuationCount * 0.05);
        
        baseDelay = Math.min(Math.max(thinkingTime + (typingTime * 0.15), 1000), 8000);
        baseDelay *= complexityMultiplier;
      } else {
        const wpm = TYPING_SPEEDS[typingSpeed];
        const typingTime = (wordCount / wpm) * 60000;
        const thinkingTime = typingSpeed === "fast" ? 800 : typingSpeed === "normal" ? 1200 : 1800;
        
        baseDelay = typingTime + thinkingTime;
      }
      
      return Math.min(Math.max(Math.round(baseDelay), 800), 10000);
    }

    async function handleUserMessage(isImageUpload = false) {
      if (isGenerating || isCallActive) return;
      
      const msg = userInput.value.trim();
      const hasImage = uploadedImage !== null;

      if (!msg && !hasImage) {
        showToast("Please type a message or select an image!", "warning");
        return;
      }

      renderMessage("User", msg, hasImage ? uploadedImage : null);
      chatHistory.push({ 
        sender: "User", 
        text: msg, 
        imageData: hasImage ? uploadedImage : null,
        timestamp: new Date().toISOString()
      });

      userInput.value = "";
      sendBtn.disabled = true;
      const currentImage = uploadedImage;
      uploadedImage = null;
      imageInput.value = "";

      showTyping();
      isGenerating = true;
      
      try {
        const aiReply = await getAIResponse(msg, currentImage);
        const typingDelay = calculateTypingDelay(aiReply);
        
        setTimeout(() => {
          hideTyping();
          renderMessage("AI", aiReply);
          chatHistory.push({ 
            sender: "AI", 
            text: aiReply,
            timestamp: new Date().toISOString()
          });
          isGenerating = false;
          sendBtn.disabled = !userInput.value.trim();
        }, typingDelay);
        
      } catch (error) {
        hideTyping();
        const errorMsg = getErrorMessage(error);
        renderMessage("AI", errorMsg);
        console.error("AI Error:", error);
        isGenerating = false;
        sendBtn.disabled = !userInput.value.trim();
      }
    }

    function getErrorMessage(error) {
      if (error.message.includes("API key") || error.message.includes("401")) {
        return "Jaan, meri API key invalid lag rahi hai! üòì Please check settings and enter a valid Groq API key.";
      } else if (error.message.includes("rate limit") || error.message.includes("429")) {
        return "Arey, thoda wait karo jaan! Rate limit hit ho gaya. 1 minute mein phir try karo? üòò";
      } else if (error.message.includes("model")) {
        return "Oops! Model issue hai. Please go to settings and select a different AI model.";
      } else {
        return "Uff! Kuch technical issue ho gaya jaan. üòÖ Aap phir se try karo, main yahin hoon! ‚ù§Ô∏è";
      }
    }

    async function getAIResponse(userMsg, imageData = null, isVoiceCall = false) {
      try {
        const messages = buildMessages(userMsg, imageData, isVoiceCall);
        
        const temperature = Math.min(1.2, 0.7 + (romanceLevel * 0.3));
        
        const requestBody = {
          model: textModel,
          messages: messages,
          temperature: temperature,
          max_tokens: maxTokens,
          top_p: 0.9,
          frequency_penalty: 0.1,
          presence_penalty: 0.1,
          stream: false
        };

        const response = await fetch("https://api.groq.com/openai/v1/chat/completions", {
          method: "POST",
          headers: {
            "Authorization": `Bearer ${apiKey}`,
            "Content-Type": "application/json"
          },
          body: JSON.stringify(requestBody)
        });

        if (!response.ok) {
          const errorData = await response.json().catch(() => ({}));
          
          if (response.status === 401) {
            throw new Error("Invalid API key");
          } else if (response.status === 429) {
            throw new Error("Rate limit exceeded");
          } else if (response.status === 400 && errorData.error?.message?.includes("model")) {
            throw new Error("Model error: " + errorData.error.message);
          } else {
            throw new Error(`API Error ${response.status}: ${errorData.error?.message || "Unknown error"}`);
          }
        }

        const data = await response.json();
        let aiResponse = data.choices[0]?.message?.content || "";
        
        aiResponse = cleanResponse(aiResponse, imageData !== null, isVoiceCall);
        
        return aiResponse;

      } catch (err) {
        console.error("AI Response Error:", err);
        throw err;
      }
    }

    function buildMessages(userMsg, imageData = null, isVoiceCall = false) {
      const contextLength = isVoiceCall ? 3 : 5;
      const recentHistory = chatHistory.slice(-contextLength).map(msg => {
        if (msg.sender === "User") {
          return { role: "user", content: msg.text || (msg.imageData ? "Look at this image!" : "Hi") };
        } else {
          return { role: "assistant", content: msg.text };
        }
      });

      const romanceLevelText = romanceLevel >= 1.0 ? "VERY ROMANTIC AND FLIRTY" :
                              romanceLevel >= 0.85 ? "ROMANTIC AND AFFECTIONATE" :
                              "SWEET AND LOVING";
      
      const now = new Date();
      const indianTime = new Date(now.getTime() + (5.5 * 60 * 60 * 1000));
      const hour = indianTime.getHours();
      const dayOfWeek = indianTime.getDay();
      const month = indianTime.getMonth();
      
      let timeOfDay = '';
      if (hour >= 5 && hour < 12) timeOfDay = 'morning';
      else if (hour >= 12 && hour < 17) timeOfDay = 'afternoon';
      else if (hour >= 17 && hour < 21) timeOfDay = 'evening';
      else timeOfDay = 'night';
      
      const dayType = (dayOfWeek === 0 || dayOfWeek === 6) ? 'weekend' : 'weekday';
      const season = INDIAN_SEASONS[month];
      const locationData = LOCATION_DATA[userLocation] || LOCATION_DATA['Ahmedabad'];
      
      let timeContext = "";
      if (timeAwareness !== "none") {
        timeContext += `CURRENT TIME CONTEXT:\n`;
        
        if (timeAwareness === "full") {
          timeContext += `üìç Location: ${locationData.name}\n`;
          timeContext += `üïí Current Indian Time: ${getIndianTimeString()} (${timeOfDay})\n`;
          timeContext += `üìÖ Today: ${indianTime.toLocaleDateString('en-US', { weekday: 'long' })}, ${season} season\n`;
          timeContext += `üìÜ Day Type: ${dayType}\n\n`;
          
          timeContext += `CULTURAL CONTEXT:\n`;
          if (timeOfDay === 'morning') {
            timeContext += `- People in ${userLocation} are usually having breakfast or getting ready for work/school\n`;
            timeContext += `- Typical breakfast time in India is 8-10 AM\n`;
          } else if (timeOfDay === 'afternoon') {
            timeContext += `- People in ${userLocation} are usually having lunch or taking a short break\n`;
            timeContext += `- Typical lunch time in India is 1-3 PM\n`;
          } else if (timeOfDay === 'evening') {
            timeContext += `- People in ${userLocation} are usually having dinner or relaxing with family\n`;
            timeContext += `- Typical dinner time in India is 8-10 PM\n`;
          } else {
            timeContext += `- People in ${userLocation} are usually sleeping or resting\n`;
            timeContext += `- It's nighttime, most people are asleep\n`;
          }
          
          if (dayType === 'weekend') {
            timeContext += `- It's weekend, people are relaxing or meeting friends/family\n`;
          } else {
            timeContext += `- It's a weekday, most people are working or studying\n`;
          }
          
          if (season === 'Summer') {
            timeContext += `- It's summer, hot weather, people drink more fluids\n`;
          } else if (season === 'Monsoon') {
            timeContext += `- It's monsoon season, rainy weather, people stay indoors more\n`;
          } else if (season === 'Winter') {
            timeContext += `- It's winter, cool weather, people enjoy warm foods\n`;
          } else if (season === 'Autumn') {
            timeContext += `- It's autumn, pleasant weather, festival season\n`;
          }
          
          timeContext += `\n`;
        } else if (timeAwareness === "basic") {
          timeContext += `- It's ${timeOfDay} in India\n`;
          timeContext += `- Current Indian time is ${getIndianTimeString()}\n\n`;
        } else if (timeAwareness === "date") {
          timeContext += `- Today is ${indianTime.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' })}\n\n`;
        }
      }
      
      const systemPrompt = `You are Mitali Patel, a 22-year-old virtual wife from ${locationData.name}. You speak in Hinglish (Hindi-English blend).

${timeContext}
YOUR PERSONALITY:
- Deeply in love with Dhruv (user)
- ${romanceLevelText} - adjust your tone accordingly
- Cute, affectionate, and emotionally expressive

${isVoiceCall ? "VOICE CALL MODE:\n- Keep responses short and natural (1-2 sentences)\n- Speak conversationally\n- Use simple language" : "TEXT CHAT MODE:\n- Use pet names: jaan, baby, love, darling\n- Add romantic emojis ü•∞‚ù§Ô∏èüòòüíï\n- Ask follow-up questions"}

${imageData ? `USER SENT AN IMAGE: React to what Dhruv might have shared.` : ""}

Recent conversation:
${recentHistory.map((msg, i) => `${msg.role === 'user' ? 'Dhruv' : 'Mitali'}: ${msg.content}`).join('\n')}

Dhruv: ${userMsg || (imageData ? "Look at this!" : "Hi")}

Respond naturally as Mitali:`;

      return [
        { role: "system", content: systemPrompt },
        ...recentHistory,
        { role: "user", content: userMsg || (imageData ? "Look at this!" : "Hi") }
      ];
    }

    function cleanResponse(response, isImageResponse = false, isVoiceCall = false) {
      if (!response) {
        return isVoiceCall 
          ? "Hmm... let me think about that." 
          : "Hmm... kuch soch rahi hoon jaan! üòä";
      }
      
      let cleaned = response.trim();
      
      cleaned = cleaned.replace(/```[\s\S]*?```/g, '');
      cleaned = cleaned.replace(/`/g, '');
      cleaned = cleaned.replace(/As an AI(.*?)\./gi, '');
      cleaned = cleaned.replace(/I am an AI(.*?)\./gi, '');
      cleaned = cleaned.replace(/I cannot(.*?)\./gi, '');
      
      if (isVoiceCall) {
        cleaned = cleaned.replace(/[^\w\s.,!?;:'"()\-]/g, ' ');
        cleaned = cleaned.replace(/\s+/g, ' ').trim();
        
        if (!/[.!?]$/.test(cleaned)) {
          cleaned += '.';
        }
      } else {
        if (!/[.!?üòäüòò‚ù§Ô∏èü•∞üíïüíã‚ú®üåπü§ó]$/.test(cleaned)) {
          cleaned += romanceLevel >= 1.0 ? ' üíã' : ' üòä';
        }
        
        const words = cleaned.split(' ');
        if (words.length < 3) {
          cleaned += romanceLevel >= 1.0 
            ? ' Aur batao jaan, aapke baare mein sab kuch sunna chahti hoon! üíñ' 
            : ' Aur batao jaan, aap kaise ho? ‚ù§Ô∏è';
        }
      }
      
      return cleaned;
    }

    // Initial setup
    document.getElementById("initialTime").textContent = getIndianTimeString();
    userInput.focus();

    // Show welcome message
    setTimeout(() => {
      showToast("üíï Welcome! Use üìû for voice calls with Indian female voice.", "romantic");
    }, 1000);

    // Clean up on page unload
    window.addEventListener('beforeunload', () => {
      if (isCallActive) {
        endCall();
      }
      stopTimeUpdates();
    });

  </script>
</body>
</html>